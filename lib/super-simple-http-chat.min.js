/*
super-simple-http-chat - v0.0.1 - 2013-05-12
* Copyright (c) 2013 Jacob Rudenstam; Licensed MIT
*/
var sshc=function(e,t){"use strict";var n=function(e,t,n){this.type="message",this.author=t,this.text=e,this.recipiants=n,this.timeStamp=new Date},r=function(e,t,n,r){this.id=e+":"+r,this.connectionId=r,this.type="client",this.email=e,this.color=t?t:this._setColor(),this.imageUrl=n,this.muted=!1};r.prototype._setColor=function(){var e="cdef".split(""),t="#";for(var n=0;n<6;n++)t+=e[Math.round(Math.random()*3)];return t};var i=function(t,n){this.config={},this.client=n,this.clients=[],this.recipiants=[],this.originalTitle=e.title,this.unread=[],this.isActive=!0};return i.prototype.urlToAnchor=function(e){var t=/^<([a-z]+)([^<]+)*(?:>(.*)<\/\1>|\s+\/>)$/ig,n=/(\b(https?|ftp|file):\/\/[A-Z0-9+&@#\/%?=~_|!:,.;]*[A-Z0-9+&@#\/%=~_|])/ig;return t.test(e)?e:e.replace(n,'<a href="$1">$1</a>')},i.prototype.arrayIndexOf=function(e,t){if(!t||typeof t!="function")return-1;if(!e||!e.length||e.length<1)return-1;for(var n=0;n<e.length;n++)if(t(e[n]))return n;return-1},i.prototype.formattedTime=function(e){var t=new Date(e);t.justify={hour:t.getHours(),min:t.getMinutes(),sec:t.getSeconds()};for(var n in t.justify)t.justify[n].toString().length<2&&(t.justify[n]="0".concat(t.justify[n].toString()));return t.justify.hour+":"+t.justify.min+"."+t.justify.sec},i.prototype.appendMessage=function(t){t.text&&(t.text=this.urlToAnchor(t.text));var n=e.createElement("li");n.innerHTML='<div class="inner-wrapper clearfix"><span class="author"> <a href="mailto:'+t.author.email+'"> '+t.author.email+'</a><span class="time"><i class="icon-time"></i> '+this.formattedTime(t.timeStamp)+'</span></span><span class="message-body">'+t.text+"</span></div>";if(t.author.imageUrl){var r=e.createElement("img");r.src=t.author.imageUrl,r.width=40,r.height=40;var i=n.getElementsByClassName("author")[0];i.insertBefore(r,i.firstChild)}n.classList.add("collapsed"),n.addEventListener("DOMNodeInsertedIntoDocument",function(){this.classList.remove("collapsed");var e={"background-color":t.author.color,height:"auto"};for(var n in e)this.style[n]=e[n]},!1),n=this.config.messagesList.insertBefore(n,this.config.messagesList.firstChild),this.config.messagesList.children.length>0&&this.config.messagesList.classList.remove("empty")},i.prototype.saveMessage=function(e,n){var r=e.timeStamp;t.localStorage.setItem(r,JSON.stringify(n))},i.prototype.sendMessage=function(e){var n;try{n=JSON.stringify(e)}catch(r){t.console.log("This can't be stringifyed as JSON : "+e),t.console.log(r)}this.config.connection.send(n)},i.prototype.appendClient=function(t){var n=t.muted?"icon-ban-circle":"icon-user",r=e.createElement("li");r.id=t.id,r.innerHTML='<i class="'+n+'"></i><span class="btn user-email" data-user-id="'+t.connectionId+'">'+t.email+"</span>",r.style.backgroundColor=t.color,this.config.clientsList.insertBefore(r,this.config.clientsList.firstChild),r.addEventListener("click",this,!1)},i.prototype.updateTitle=function(t){this.isActive||(this.unread.push(t),e.title=this.originalTitle+" ("+this.unread.length+")")},i.prototype.removeClient=function(t){var n=e.getElementById(t.email);this.config.clientsList.removeChild(n)},i.prototype.updateClient=function(t){var n=t.muted?"icon-ban-circle":"icon-user",r=e.getElementById(t.id);r.innerHTML='<i class="'+n+'"></i><span class="btn user-email" data-user-id="'+t.connectionId+'">'+t.email+"</span>",r.style.backgroundColor=t.color},i.prototype.messageToServer=function(e){e.preventDefault();var t=this.config.messagesInput.value;if(t.length<1)return;if(!this.client.email){this.client.email=t,this.sendMessage(this.client),this.config.messagesInput.value="",this.config.messagesInput.setAttribute("placeholder","Go ahead and type...");return}var r=new n(t,this.client,this.recipiants);r.recipiants.indexOf(this.client.connectionId)<0&&r.recipiants.push(this.client.connectionId),this.sendMessage(r),this.config.messagesInput.value=""},i.prototype.messageFromServer=function(e){var n;try{n=JSON.parse(e.data)}catch(i){t.console.log("The data returned is not correctly formatted JSON");return}switch(n.type){case"message":this.isMuted(n)||(this.appendMessage(n),this.saveMessage(e,n),this.updateTitle(n));break;case"client":var s=new r(n.email,n.color,n.imageUrl,n.connectionId),o=this.arrayIndexOf(this.clients,function(e){return e.id===s.id});this.client.email===s.email&&(this.client=s,t.localStorage.setItem("client",JSON.stringify(this.client))),o<0&&(this.clients.push(s),this.appendClient(s),this.recipiants.indexOf(n.connectionId)<0&&this.recipiants.push(n.connectionId));break;case"removeClient":this.removeClient(n)}},i.prototype.getClients=function(){var e=new n("none",this.client);e.type="getClients",this.sendMessage(e)},i.prototype.handleEvent=function(t){switch(t.type){case"submit":this.messageToServer(t);break;case"message":this.messageFromServer(t);break;case"focus":this.isActive=!0,this.unread=[],e.title=this.originalTitle;break;case"blur":this.isActive=!1;break;case"click":this.toggleMute(t)}},i.prototype.toggleMute=function(e){var n=parseInt(e.target.getAttribute("data-user-id"),10),r=this.getClientById(n,!0),i=this.clients[r],s=this.recipiants.indexOf(n);s>=0?(t.console.log("Mutein': "+i.email),i.muted=!0,this.updateClient(i),this.recipiants.splice(s,1)):(t.console.log("Unmutein': "+i.email),i.muted=!1,this.updateClient(i),this.recipiants.push(n))},i.prototype.getClientById=function(e,t){var n=this.arrayIndexOf(this.clients,function(t){return t.connectionId===e});return t?n:this.clients[n]},i.prototype.init=function(){this.client=new r;if(t.localStorage&&t.localStorage.length>0)for(var e in t.localStorage){var n=t.localStorage.getItem(e);e!=="client"?this.appendMessage(JSON.parse(n)):this.client.email||(this.client=JSON.parse(n),this.sendMessage(this.client),this.config.messagesInput.setAttribute("placeholder","Go ahead and type..."))}this.config.messagesForm.addEventListener("submit",this,!1),this.config.connection.addEventListener("message",this,!1),t.addEventListener("focus",this,!1),t.addEventListener("blur",this,!1),this.getClients()},i.prototype.signOff=function(){this.client.email&&(this.client.type="removeClient",this.sendMessage(this.client),this.config.connection.close(),this.config.messagesList.innerHTML="",this.config.messagesList.classList.add("empty"),t.localStorage.clear(),t.location.reload())},i.prototype.isMuted=function(e){var t=this.arrayIndexOf(this.clients,function(t){return t.email===e.author.email});return this.clients[t].muted},{Chat:i,Client:r}}(document,window),urlToAnchor=function(){"use strict";var e={replace:function(e){var t=/^<([a-z]+)([^<]+)*(?:>(.*)<\/\1>|\s+\/>)$/ig,n=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return t.test(e)?e:e.replace(n,'<a href="$1">$1</a>')}};return e}();